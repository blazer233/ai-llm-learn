<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LSB é”™è¯¯ç›‘æ§æ¼”ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .card h2 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5rem;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
    
    .demo-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .demo-section {
        grid-template-columns: 1fr;
      }
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
      margin: 5px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-danger {
      background: #f56565;
      color: white;
    }
    
    .btn-danger:hover {
      background: #e53e3e;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(245, 101, 101, 0.4);
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover {
      background: #38a169;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
    }
    
    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .input-group textarea {
      resize: vertical;
      min-height: 100px;
      font-family: 'Courier New', monospace;
    }
    
    .breadcrumbs {
      max-height: 300px;
      overflow-y: auto;
      background: #f7fafc;
      padding: 15px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .breadcrumb-item {
      padding: 8px;
      margin-bottom: 5px;
      background: white;
      border-left: 3px solid #667eea;
      border-radius: 4px;
    }
    
    .breadcrumb-item .time {
      color: #999;
      font-size: 0.85rem;
    }
    
    .status {
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
    }
    
    .status.success {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .status.error {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .status.info {
      background: #bee3f8;
      color: #2c5282;
    }
    
    .image-preview {
      max-width: 100%;
      border-radius: 6px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    
    .code {
      background: #2d3748;
      color: #68d391;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ” LSB é”™è¯¯ç›‘æ§æ¼”ç¤º</h1>
      <p>åŸºäº LSB éšå†™æŠ€æœ¯çš„å‰ç«¯é”™è¯¯ç›‘æ§æ–¹æ¡ˆ</p>
    </div>

    <!-- åŠŸèƒ½æ¼”ç¤º -->
    <div class="card">
      <h2>ğŸ“ åŠŸèƒ½æ¼”ç¤º</h2>
      <div class="demo-section">
        <div>
          <h3 style="margin-bottom: 15px;">è§¦å‘é”™è¯¯</h3>
          <button class="btn btn-danger" onclick="triggerError()">
            æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯
          </button>
          <button class="btn btn-danger" onclick="triggerPromiseError()">
            è§¦å‘ Promise é”™è¯¯
          </button>
          <button class="btn btn-primary" onclick="manualCapture()">
            æ‰‹åŠ¨æ•è·é”™è¯¯
          </button>
        </div>
        
        <div>
          <h3 style="margin-bottom: 15px;">ç”¨æˆ·è¡Œä¸º</h3>
          <button class="btn btn-primary" id="test-btn">ç‚¹å‡»æµ‹è¯•æŒ‰é’®</button>
          <input type="text" placeholder="è¾“å…¥æµ‹è¯•æ–‡æœ¬" style="width: 100%; margin-top: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          <button class="btn btn-success" onclick="navigate('/test')">
            æ¨¡æ‹Ÿè·¯ç”±è·³è½¬
          </button>
        </div>
      </div>
    </div>

    <!-- LSB ç¼–è§£ç æµ‹è¯• -->
    <div class="card">
      <h2>ğŸ” LSB ç¼–è§£ç æµ‹è¯•</h2>
      <div class="demo-section">
        <div>
          <div class="input-group">
            <label>é€‰æ‹©å›¾ç‰‡</label>
            <input type="file" id="imageInput" accept="image/*">
            <button class="btn btn-primary" onclick="useTestImage()" style="margin-top: 10px; width: 100%;">
              ä½¿ç”¨æµ‹è¯•å›¾ç‰‡
            </button>
          </div>
          
          <div class="input-group">
            <label>è¦éšè—çš„ä¿¡æ¯</label>
            <textarea id="messageInput" placeholder='è¾“å…¥è¦éšè—çš„ä¿¡æ¯...'>{"version":"1.0.0","type":"error","message":"æµ‹è¯•é”™è¯¯ä¿¡æ¯","route":"/test","timestamp":1701234567890}</textarea>
          </div>
          
          <button class="btn btn-primary" onclick="testEncode()">
            ç¼–ç ï¼ˆéšè—ä¿¡æ¯ï¼‰
          </button>
          <button class="btn btn-success" onclick="testDecode()">
            è§£ç ï¼ˆæå–ä¿¡æ¯ï¼‰
          </button>
          
          <div id="encodeStatus"></div>
        </div>
        
        <div>
          <h3 style="margin-bottom: 15px;">ç»“æœé¢„è§ˆ</h3>
          <div id="imagePreview"></div>
          <div id="decodeResult"></div>
        </div>
      </div>
    </div>

    <!-- ç”¨æˆ·è¡Œä¸ºè¿½è¸ª -->
    <div class="card">
      <h2>ğŸ‘£ ç”¨æˆ·è¡Œä¸ºè¿½è¸ª</h2>
      <div id="breadcrumbsDisplay" class="breadcrumbs">
        <p style="color: #999;">æš‚æ— æ“ä½œè®°å½•</p>
      </div>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="card">
      <h2>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h2>
      <div class="stats">
        <div class="stat-card">
          <div class="value" id="errorCount">0</div>
          <div class="label">æ•è·é”™è¯¯æ•°</div>
        </div>
        <div class="stat-card">
          <div class="value" id="breadcrumbCount">0</div>
          <div class="label">ç”¨æˆ·æ“ä½œæ•°</div>
        </div>
        <div class="stat-card">
          <div class="value" id="reportCount">0</div>
          <div class="label">ä¸ŠæŠ¥æ¬¡æ•°</div>
        </div>
      </div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div class="card">
      <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
      <div class="code">
// 1. å¼•å…¥è„šæœ¬
&lt;script src="lsb-core.js"&gt;&lt;/script&gt;
&lt;script src="error-monitor.js"&gt;&lt;/script&gt;
&lt;script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"&gt;&lt;/script&gt;

// 2. åˆå§‹åŒ–ç›‘æ§
const monitor = new LSBErrorMonitor({
  version: '1.0.0',
  apiUrl: '/api/error-report',
  captureScreenshot: true,
  onError: (data) => {
    console.log('é”™è¯¯æ•è·:', data);
  }
});

// 3. æ‰‹åŠ¨æ•è·é”™è¯¯
try {
  // ä½ çš„ä»£ç 
} catch (error) {
  monitor.captureError(error, { context: 'additional info' });
}
      </div>
    </div>
  </div>

  <!-- å¼•å…¥ä¾èµ– -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="lsb-core.js"></script>
  <script src="error-monitor.js"></script>

  <script>
    // åˆå§‹åŒ–ç›‘æ§
    const monitor = new LSBErrorMonitor({
      version: '1.0.0',
      apiUrl: '/api/error-report',
      captureScreenshot: true,
      onError: (data) => {
        console.log('é”™è¯¯æ•è·:', data);
        updateStats();
      }
    });

    // ç»Ÿè®¡å˜é‡
    let errorCount = 0;
    let reportCount = 0;

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
      errorCount++;
      document.getElementById('errorCount').textContent = errorCount;
      document.getElementById('breadcrumbCount').textContent = monitor.breadcrumbs.length;
    }

    // æ›´æ–°é¢åŒ…å±‘æ˜¾ç¤º
    setInterval(() => {
      const display = document.getElementById('breadcrumbsDisplay');
      if (monitor.breadcrumbs.length === 0) {
        display.innerHTML = '<p style="color: #999;">æš‚æ— æ“ä½œè®°å½•</p>';
        return;
      }
      
      display.innerHTML = monitor.breadcrumbs.map(crumb => {
        const time = new Date(crumb.time).toLocaleTimeString();
        return `
          <div class="breadcrumb-item">
            <strong>${crumb.type}</strong>: ${crumb.target || crumb.to || ''}
            <div class="time">${time}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('breadcrumbCount').textContent = monitor.breadcrumbs.length;
    }, 1000);

    // è§¦å‘è¿è¡Œæ—¶é”™è¯¯
    function triggerError() {
      throw new Error('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯ï¼');
    }

    // è§¦å‘ Promise é”™è¯¯
    function triggerPromiseError() {
      Promise.reject(new Error('è¿™æ˜¯ä¸€ä¸ª Promise æ‹’ç»é”™è¯¯ï¼'));
    }

    // æ‰‹åŠ¨æ•è·é”™è¯¯
    async function manualCapture() {
      try {
        const error = new Error('æ‰‹åŠ¨æ•è·çš„æµ‹è¯•é”™è¯¯');
        await monitor.captureError(error, {
          component: 'demo-page',
          action: 'manual-test'
        });
        
        showStatus('success', 'âœ… é”™è¯¯å·²æ‰‹åŠ¨æ•è·å¹¶ä¸ŠæŠ¥');
        reportCount++;
        document.getElementById('reportCount').textContent = reportCount;
      } catch (err) {
        showStatus('error', 'âŒ æ•è·å¤±è´¥: ' + err.message);
      }
    }

    // æ¨¡æ‹Ÿè·¯ç”±è·³è½¬
    function navigate(path) {
      history.pushState({}, '', path);
      showStatus('info', `ğŸ“ å·²è·³è½¬åˆ°: ${path}`);
    }

    // æ˜¾ç¤ºçŠ¶æ€
    function showStatus(type, message) {
      const statusDiv = document.createElement('div');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      document.body.appendChild(statusDiv);
      
      setTimeout(() => {
        statusDiv.style.opacity = '0';
        statusDiv.style.transition = 'opacity 0.5s';
        setTimeout(() => statusDiv.remove(), 500);
      }, 3000);
    }

    // LSB ç¼–ç æµ‹è¯•
    let originalImageData = null;

    async function testEncode() {
      const fileInput = document.getElementById('imageInput');
      const messageInput = document.getElementById('messageInput');
      
      if (!fileInput.files[0]) {
        showStatus('error', 'è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
        return;
      }
      
      if (!messageInput.value) {
        showStatus('error', 'è¯·è¾“å…¥è¦éšè—çš„ä¿¡æ¯');
        return;
      }
      
      try {
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        showStatus('info', 'ğŸ”„ æ­£åœ¨å¤„ç†å›¾ç‰‡...');
        
        reader.onload = async (e) => {
          const img = new Image();
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              canvas.width = img.width;
              canvas.height = img.height;
              ctx.drawImage(img, 0, 0);
              
              // è·å–åƒç´ æ•°æ®
              originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              
              // è®¡ç®—å®¹é‡
              const capacity = calculateCapacity(canvas.width, canvas.height);
              console.log(`å›¾ç‰‡å®¹é‡: ${capacity} å­—ç¬¦`);
              
              // ç¼–ç ï¼ˆç›´æ¥ä¿®æ”¹ originalImageData.dataï¼‰
              const message = messageInput.value;
              console.log(`å°è¯•éšè— ${message.length} å­—ç¬¦`);
              
              const result = encodeMessage(originalImageData.data, message);
              
              // å°†ä¿®æ”¹åçš„æ•°æ®å†™å› canvas
              ctx.putImageData(originalImageData, 0, 0);
              const dataURL = canvas.toDataURL('image/png');
              
              // æ˜¾ç¤ºç»“æœ
              document.getElementById('imagePreview').innerHTML = `
                <h3 style="margin-bottom: 10px; color: #333;">ç¼–ç åçš„å›¾ç‰‡</h3>
                <img src="${dataURL}" class="image-preview" alt="ç¼–ç åçš„å›¾ç‰‡">
                <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                  ğŸ’¡ å›¾ç‰‡å·²åŒ…å«éšå†™ä¿¡æ¯ï¼Œä½†è§†è§‰ä¸Šä¸åŸå›¾æ— å·®å¼‚
                </p>
              `;
              
              document.getElementById('encodeStatus').innerHTML = `
                <div class="status success">
                  âœ… ç¼–ç æˆåŠŸ<br>
                  å›¾ç‰‡å°ºå¯¸: ${canvas.width}x${canvas.height}<br>
                  æ¶ˆæ¯é•¿åº¦: ${result.messageLength} å­—ç¬¦<br>
                  ä½¿ç”¨ä½æ•°: ${result.bitsUsed} ä½<br>
                  ä¿®æ”¹åƒç´ : ${result.pixelsModified} ä¸ª<br>
                  å‰©ä½™å®¹é‡: ${capacity - result.messageLength} å­—ç¬¦
                </div>
              `;
              
              showStatus('success', 'âœ… ç¼–ç æˆåŠŸï¼ç‚¹å‡»"è§£ç "å¯éªŒè¯');
              
            } catch (err) {
              console.error('ç¼–ç é”™è¯¯:', err);
              showStatus('error', 'ç¼–ç å¤±è´¥: ' + err.message);
              document.getElementById('encodeStatus').innerHTML = `
                <div class="status error">
                  âŒ ç¼–ç å¤±è´¥: ${err.message}
                </div>
              `;
            }
          };
          
          img.onerror = () => {
            showStatus('error', 'å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
          };
          
          img.src = e.target.result;
        };
        
        reader.readAsDataURL(file);
      } catch (err) {
        console.error('è¯»å–æ–‡ä»¶é”™è¯¯:', err);
        showStatus('error', 'è¯»å–æ–‡ä»¶å¤±è´¥: ' + err.message);
      }
    }

    // LSB è§£ç æµ‹è¯•
    function testDecode() {
      if (!originalImageData) {
        showStatus('error', 'è¯·å…ˆè¿›è¡Œç¼–ç ');
        return;
      }
      
      try {
        showStatus('info', 'ğŸ”„ æ­£åœ¨è§£ç ...');
        
        const message = decodeMessage(originalImageData.data);
        
        console.log('è§£ç æˆåŠŸï¼Œæå–çš„æ¶ˆæ¯:', message);
        
        document.getElementById('decodeResult').innerHTML = `
          <div class="status success" style="margin-top: 15px;">
            <strong>âœ… è§£ç æˆåŠŸ</strong>
            <p style="margin: 10px 0 5px 0; font-weight: 600;">æå–çš„ä¿¡æ¯ï¼š</p>
            <div class="code" style="margin-top: 10px; text-align: left; white-space: pre-wrap; word-break: break-word;">
${message}
            </div>
          </div>
        `;
        
        showStatus('success', 'âœ… ä¿¡æ¯å·²æˆåŠŸæå–');
      } catch (err) {
        console.error('è§£ç é”™è¯¯:', err);
        showStatus('error', 'è§£ç å¤±è´¥: ' + err.message);
        document.getElementById('decodeResult').innerHTML = `
          <div class="status error" style="margin-top: 15px;">
            âŒ è§£ç å¤±è´¥: ${err.message}
          </div>
        `;
      }
    }

    // è¦†ç›–ä¸Šä¼ å‡½æ•°ï¼ˆæ¼”ç¤ºç”¨ï¼‰
    monitor.upload = async function(payload) {
      console.log('[æ¼”ç¤ºæ¨¡å¼] æ¨¡æ‹Ÿä¸Šä¼ :', payload);
      reportCount++;
      document.getElementById('reportCount').textContent = reportCount;
      
      if (payload.type === 'image') {
        // æ˜¾ç¤ºéšå†™åçš„å›¾ç‰‡
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        modal.innerHTML = `
          <div style="background: white; padding: 30px; border-radius: 12px; max-width: 90%; max-height: 90%; overflow: auto;">
            <h2>ğŸ“¸ é”™è¯¯æˆªå›¾ï¼ˆå«éšå†™ä¿¡æ¯ï¼‰</h2>
            <img src="${payload.data}" style="max-width: 100%; border-radius: 6px; margin-top: 20px;">
            <p style="margin-top: 15px; color: #666;">
              è¯¥å›¾ç‰‡å·²éšå†™é”™è¯¯ä¿¡æ¯ï¼Œè§†è§‰ä¸Šä¸åŸå›¾æ— å·®å¼‚
            </p>
            <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px;">
              å…³é—­
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
      }
      
      return { success: true };
    };
    
    // ç”Ÿæˆæµ‹è¯•å›¾ç‰‡
    function useTestImage() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // åˆ›å»ºä¸€ä¸ª 400x300 çš„æ¸å˜èƒŒæ™¯å›¾ç‰‡
      canvas.width = 400;
      canvas.height = 300;
      
      // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
      const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      gradient.addColorStop(0, '#667eea');
      gradient.addColorStop(0.5, '#764ba2');
      gradient.addColorStop(1, '#f093fb');
      
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // æ·»åŠ æ–‡å­—
      ctx.font = 'bold 32px Arial';
      ctx.fillStyle = 'white';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(0,0,0,0.3)';
      ctx.shadowBlur = 10;
      ctx.fillText('LSB æµ‹è¯•å›¾ç‰‡', canvas.width / 2, canvas.height / 2 - 30);
      
      ctx.font = '18px Arial';
      ctx.fillText('400 x 300', canvas.width / 2, canvas.height / 2 + 20);
      
      // è½¬æ¢ä¸º blob
      canvas.toBlob((blob) => {
        const file = new File([blob], 'test-image.png', { type: 'image/png' });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        document.getElementById('imageInput').files = dataTransfer.files;
        
        showStatus('success', 'âœ… å·²åŠ è½½æµ‹è¯•å›¾ç‰‡ï¼ˆ400x300ï¼‰');
      }, 'image/png');
    }
    
    console.log('%cğŸ” LSB é”™è¯¯ç›‘æ§å·²å¯åŠ¨', 'color: #667eea; font-size: 16px; font-weight: bold;');
    console.log('%cå°è¯•è§¦å‘é”™è¯¯æˆ–è¿›è¡Œ LSB ç¼–è§£ç æµ‹è¯•', 'color: #764ba2; font-size: 14px;');
  </script>
</body>
</html>

# A2UI æŠ€æœ¯æ–‡æ¡£

> æ·±å…¥äº†è§£ A2UI ç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„å’Œæ ¸å¿ƒä¾èµ–

## æŠ€æœ¯æ ˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ç”¨æˆ·ç•Œé¢ (Next.js + React)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   CopilotChat (èŠå¤©ç•Œé¢)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    CopilotKit Runtime (åè°ƒå±‚)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  A2UIAgent (AbstractAgent)       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Observable (RxJS æµå¼)     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      AI Service (è…¾è®¯æ··å…ƒ API)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Prompt â†’ AI â†’ A2UI JSON        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Validator & Renderer (æ¸²æŸ“å±‚)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  JSON Schema (Ajv)               â”‚  â”‚
â”‚  â”‚  TDesign Components (30+ ç»„ä»¶)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## TDesign ç»„ä»¶æ˜ å°„

### æ”¯æŒçš„ç»„ä»¶ç±»å‹ï¼ˆ30+ ç§ï¼‰

A2UI ç°å·²å®Œæ•´æ˜ å°„åˆ° TDesign React ç»„ä»¶åº“ï¼Œæ”¯æŒä»¥ä¸‹ç»„ä»¶ï¼š

#### å¸ƒå±€ç»„ä»¶
- `container` â†’ Space (å¸¦æ–¹å‘å’Œé—´è·)
- `space` â†’ Space (çµæ´»å¸ƒå±€)
- `divider` â†’ Divider (åˆ†å‰²çº¿)

#### è¡¨å•è¾“å…¥ç»„ä»¶
- `textInput` â†’ Input
- `textArea` â†’ Input (textarea æ¨¡å¼)
- `checkbox` â†’ Checkbox
- `radio` â†’ Radio
- `radioGroup` â†’ RadioGroup
- `select` â†’ Select
- `switch` â†’ Switch
- `slider` â†’ Slider
- `datePicker` â†’ DatePicker
- `timePicker` â†’ TimePicker
- `upload` â†’ Upload

#### å±•ç¤ºç»„ä»¶
- `heading` â†’ Typography.Title / h1-h6
- `paragraph` â†’ Typography.Paragraph / p
- `text` â†’ Typography.Text / span
- `link` â†’ Link
- `image` â†’ Image
- `list` â†’ List
- `table` â†’ Table
- `tag` â†’ Tag
- `badge` â†’ Badge
- `avatar` â†’ Avatar

#### åé¦ˆç»„ä»¶
- `alert` â†’ Alert
- `progress` â†’ Progress
- `tooltip` â†’ Tooltip
- `popover` â†’ Popover

#### å¤åˆç»„ä»¶
- `form` â†’ Form
- `card` â†’ Card
- `tabs` â†’ Tabs
- `steps` â†’ Steps
- `pagination` â†’ Pagination
- `breadcrumb` â†’ Breadcrumb
- `dropdown` â†’ Dropdown

### ç»„ä»¶æ˜ å°„ç¤ºä¾‹

```javascript
// A2UI JSON å®šä¹‰
{
  "id": "btn-1",
  "type": "button",
  "props": {
    "label": "æäº¤",
    "variant": "primary",
    "size": "medium"
  }
}

// æ¸²æŸ“ä¸º TDesign ç»„ä»¶
<Button 
  variant="base" 
  theme="primary" 
  size="medium"
>
  æäº¤
</Button>
```

## æ ¸å¿ƒä¾èµ–è¯¦è§£

### 1. CopilotKit

**ç‰ˆæœ¬:** `@copilotkit/runtime@^1.4.1`

**ä½œç”¨:** æä¾› AI å¯¹è¯åŸºç¡€è®¾æ–½ï¼Œç®€åŒ– Agent å¼€å‘

**æ ¸å¿ƒæ¦‚å¿µ:**

- **CopilotRuntime** - è¿è¡Œæ—¶ç¯å¢ƒï¼Œç®¡ç† Agent æ‰§è¡Œ
- **CopilotChat** - React èŠå¤©ç»„ä»¶ï¼Œæä¾›å¯¹è¯ UI
- **Agent** - æ™ºèƒ½ä»£ç†ï¼Œå¤„ç†ç”¨æˆ·è¾“å…¥
- **Activity Renderer** - è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼ˆç”¨äºæ˜¾ç¤º A2UIï¼‰

#### å‰ç«¯é›†æˆ (`src/app/page.js`)

```javascript
import { CopilotChat, CopilotKitProvider } from '@copilotkit/react-core/v2';

const activityRenderers = [TDesignRenderer];

<CopilotKitProvider
  runtimeUrl="/api/copilotkit"
  renderActivityMessages={activityRenderers}
>
  <CopilotChat placeholder="æè¿°æ‚¨æƒ³è¦çš„ç•Œé¢..." />
</CopilotKitProvider>
```

#### åç«¯é›†æˆ (`src/app/api/copilotkit/[[...slug]]/route.js`)

```javascript
import { CopilotRuntime, InMemoryAgentRunner } from '@copilotkit/runtime/v2';

const agentRunner = new InMemoryAgentRunner({
  agents: [new A2UIAgent()],
});

const app = new CopilotRuntime({
  agentRunners: [agentRunner],
});

export const { GET, POST } = createCopilotEndpoint({ app });
```

---

### 2. @ag-ui/client

**ç‰ˆæœ¬:** `@ag-ui/client@^0.1.4`

**ä½œç”¨:** æä¾› Agent åŸºç±»å’Œåè®®æ ‡å‡†

**æ ¸å¿ƒç±»:**

- **AbstractAgent** - Agent æŠ½è±¡åŸºç±»

#### ç»§æ‰¿å®ç° (`src/lib/copilotkit-a2ui-agent.js`)

```javascript
import { AbstractAgent } from '@ag-ui/client';

export class A2UIAgent extends AbstractAgent {
  constructor(config = {}) {
    super({
      agentId: 'a2ui-agent',
      description: 'AI-powered UI generation agent',
      threadId: config.threadId,
      initialMessages: [],
      initialState: {},
    });
  }

  // å¿…é¡»å®ç°
  run(input) {
    return new Observable(observer => {
      // å¤„ç†æ¶ˆæ¯é€»è¾‘
    });
  }

  clone() {
    return new A2UIAgent({...});
  }
}
```

**å…³é”®æ–¹æ³•:**

- `run(input)` - å¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œè¿”å› Observable
- `clone()` - å…‹éš† Agent å®ä¾‹
- `messages` / `state` - å¯¹è¯å†å²å’ŒçŠ¶æ€ç®¡ç†

---

### 3. RxJS Observable

**ç‰ˆæœ¬:** `rxjs@^7.8.1`

**ä½œç”¨:** å®ç°æµå¼å“åº”ï¼Œæ”¯æŒå¼‚æ­¥äº‹ä»¶æµ

#### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ Observableï¼Ÿ

åœ¨ A2UI é¡¹ç›®ä¸­ä½¿ç”¨ Observable è€Œä¸æ˜¯ Promise/async-await çš„æ ¸å¿ƒåŸå› ï¼š

##### 1. **å¤šå€¼å¼‚æ­¥æµçš„å¤©ç„¶æ”¯æŒ**

**Promise çš„é™åˆ¶ï¼š**
```javascript
// Promise åªèƒ½è¿”å›å•ä¸ªå€¼
async function run() {
  const result = await generateUI();
  return result; // åªèƒ½è¿”å›ä¸€æ¬¡
}
```

**Observable çš„ä¼˜åŠ¿ï¼š**
```javascript
// Observable å¯ä»¥å‘é€å¤šä¸ªäº‹ä»¶
function run() {
  return new Observable(observer => {
    observer.next({ type: 'RUN_STARTED' });      // äº‹ä»¶1: å¼€å§‹
    observer.next({ type: 'TEXT_MESSAGE' });     // äº‹ä»¶2: æ–‡æœ¬
    observer.next({ type: 'ACTIVITY_SNAPSHOT' }); // äº‹ä»¶3: ç»„ä»¶
    observer.next({ type: 'RUN_FINISHED' });     // äº‹ä»¶4: å®Œæˆ
    observer.complete();                         // æ ‡è®°æµç»“æŸ
  });
}
```

**åœ¨ A2UI ä¸­çš„åº”ç”¨ï¼š**
- å…ˆå‘é€æ–‡æœ¬æ¶ˆæ¯ç»™ç”¨æˆ·ï¼ˆ"æ­£åœ¨ç”Ÿæˆç•Œé¢..."ï¼‰
- å†å‘é€ç”Ÿæˆçš„ UI ç»„ä»¶
- æœ€åå‘é€å®Œæˆä¿¡å·

è¿™ç§**æ¸è¿›å¼åé¦ˆ**ç”¨ Promise æ— æ³•å®ç°ã€‚

##### 2. **CopilotKit æ¡†æ¶å¼ºåˆ¶è¦æ±‚**

CopilotKit çš„ `AbstractAgent` åŸºç±»å®šä¹‰äº† `run()` æ–¹æ³•å¿…é¡»è¿”å› Observableï¼š

```typescript
// @ag-ui/client æºç å®šä¹‰
abstract class AbstractAgent {
  abstract run(input: AgentInput): Observable<AgentEvent>;
}
```

**ä¸ºä»€ä¹ˆ CopilotKit é€‰æ‹© Observableï¼Ÿ**

å› ä¸º AI å¯¹è¯åœºæ™¯å¤©ç„¶éœ€è¦æµå¼å“åº”ï¼š
- ChatGPT å¼çš„é€å­—è¾“å‡º
- ä¸­é—´çŠ¶æ€æ›´æ–°ï¼ˆæ€è€ƒä¸­ã€ç”Ÿæˆä¸­ï¼‰
- å¤šæ¨¡æ€è¾“å‡ºï¼ˆæ–‡æœ¬ + å›¾ç‰‡ + ç»„ä»¶ï¼‰

Promise åªèƒ½"å…¨æœ‰æˆ–å…¨æ— "ï¼Œæ— æ³•å®ç°è¿™äº›æ•ˆæœã€‚

##### 3. **æµå¼è¾“å‡ºçš„ç”¨æˆ·ä½“éªŒä¼˜åŠ¿**

**å¯¹æ¯”æ•ˆæœï¼š**

| Promise (ç­‰å¾…å…¨éƒ¨å®Œæˆ) | Observable (æµå¼è¾“å‡º) |
|---|---|
| ç”¨æˆ·ç­‰å¾… 3 ç§’ â†’ çªç„¶æ˜¾ç¤ºå®Œæ•´ç•Œé¢ | ç«‹å³æ˜¾ç¤º"æ­£åœ¨ç”Ÿæˆ" â†’ 1 ç§’åæ˜¾ç¤ºæ–‡æœ¬ â†’ 2 ç§’åæ˜¾ç¤ºç»„ä»¶ |
| æ— æ³•æ„ŸçŸ¥è¿›åº¦ | å®æ—¶åé¦ˆï¼Œé™ä½ç„¦è™‘ |
| å¡é¡¿æ„Ÿå¼º | æµç•…ä½“éªŒ |

**å®é™…ä»£ç å®ç°ï¼š**
```javascript
run(input) {
  return new Observable(observer => {
    (async () => {
      // ç«‹å³åé¦ˆï¼šå¼€å§‹å¤„ç†
      observer.next({ type: 'RUN_STARTED', runId, threadId });
      
      // 1ç§’åï¼šæ˜¾ç¤ºæç¤ºæ–‡æœ¬
      const messageId = this.generateMessageId();
      observer.next({ type: 'TEXT_MESSAGE_START', messageId });
      observer.next({ type: 'TEXT_MESSAGE_CONTENT', messageId, delta: 'æ­£åœ¨ç”Ÿæˆç•Œé¢...' });
      observer.next({ type: 'TEXT_MESSAGE_END', messageId });
      
      // è°ƒç”¨ AIï¼ˆå¯èƒ½éœ€è¦ 2-3 ç§’ï¼‰
      const result = await this.processMessage(userInput);
      
      // AI è¿”å›åï¼šç«‹å³æ˜¾ç¤ºç»„ä»¶
      if (result.a2ui?.components?.length) {
        observer.next({
          type: 'ACTIVITY_SNAPSHOT',
          messageId: this.generateMessageId(),
          activityType: 'a2ui-surface',
          content: { operations: [result.a2ui] },
        });
      }
      
      // æ ‡è®°å®Œæˆ
      observer.next({ type: 'RUN_FINISHED', runId, threadId });
      observer.complete();
    })();
  });
}
```

##### 4. **é”™è¯¯å¤„ç†çš„çµæ´»æ€§**

**Promise é”™è¯¯å¤„ç†ï¼š**
```javascript
async function run() {
  try {
    return await generateUI();
  } catch (error) {
    throw error; // æ•´ä¸ªæµç¨‹ä¸­æ–­
  }
}
```

**Observable é”™è¯¯å¤„ç†ï¼š**
```javascript
return new Observable(observer => {
  (async () => {
    try {
      observer.next({ type: 'RUN_STARTED' });
      const result = await generateUI();
      observer.next({ type: 'RESULT', result });
      observer.complete();
    } catch (error) {
      // å¯ä»¥å‘é€é”™è¯¯äº‹ä»¶è€Œä¸ä¸­æ–­æ•´ä¸ªæµ
      observer.next({ 
        type: 'RUN_ERROR', 
        message: `ç”Ÿæˆå¤±è´¥: ${error.message}` 
      });
      observer.error(error); // å¯é€‰ï¼šå½»åº•ç»ˆæ­¢
    }
  })();
});
```

**ä¼˜åŠ¿ï¼š**
- å¯ä»¥å‘é€éƒ¨åˆ†ç»“æœåå†æŠ¥é”™
- é”™è¯¯ä¿¡æ¯å¯ä»¥ä½œä¸ºäº‹ä»¶å‘é€ç»™å‰ç«¯æ˜¾ç¤º
- ä¸ä¼šä¸¢å¤±å·²ç»å‘é€çš„æ•°æ®

##### 5. **äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ‡å‡†æ¨¡å¼**

Observable æ˜¯**å“åº”å¼ç¼–ç¨‹ (Reactive Programming)** çš„æ ¸å¿ƒï¼š

```javascript
// è®¢é˜… Observable
agent.run(input).subscribe({
  next: (event) => {
    // å¤„ç†æ¯ä¸ªäº‹ä»¶
    switch(event.type) {
      case 'RUN_STARTED': 
        console.log('å¼€å§‹è¿è¡Œ');
        break;
      case 'TEXT_MESSAGE_CONTENT':
        appendMessage(event.delta); // é€å­—æ˜¾ç¤º
        break;
      case 'ACTIVITY_SNAPSHOT':
        renderComponent(event.content); // æ¸²æŸ“ç»„ä»¶
        break;
    }
  },
  error: (err) => console.error('é”™è¯¯:', err),
  complete: () => console.log('æµç»“æŸ'),
});
```

**ç±»æ¯”ç†è§£ï¼š**
- **Promise** = ä¸€æ¬¡æ€§å¿«é€’ï¼ˆå¯„äº†å°±ç­‰æ”¶è´§ï¼‰
- **Observable** = ç›´æ’­æµï¼ˆæŒç»­æ¨é€ç”»é¢ï¼‰

#### Observable æ ¸å¿ƒæ¦‚å¿µ

**Observableï¼ˆå¯è§‚å¯Ÿå¯¹è±¡ï¼‰ï¼š**
- æ•°æ®æµçš„ç”Ÿäº§è€…
- æƒ°æ€§æ±‚å€¼ï¼ˆè®¢é˜…æ—¶æ‰æ‰§è¡Œï¼‰
- å¯ä»¥å‘é€å¤šä¸ªå€¼

**Observerï¼ˆè§‚å¯Ÿè€…ï¼‰ï¼š**
- æ•°æ®æµçš„æ¶ˆè´¹è€…
- å®šä¹‰ä¸‰ä¸ªå›è°ƒï¼š`next`, `error`, `complete`

**Subscriptionï¼ˆè®¢é˜…ï¼‰ï¼š**
- è¿æ¥ Observable å’Œ Observer
- å¯ä»¥å–æ¶ˆè®¢é˜…é‡Šæ”¾èµ„æº

#### æµå¼å“åº”å®ç°

```javascript
import { Observable } from 'rxjs';

run(input) {
  return new Observable(observer => {
    (async () => {
      // 1. å¼€å§‹è¿è¡Œ
      observer.next({ type: 'RUN_STARTED', runId, threadId });

      // 2. å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼ˆå¯ä»¥åˆ†å¤šæ¬¡å‘é€ï¼Œå®ç°æ‰“å­—æœºæ•ˆæœï¼‰
      observer.next({ type: 'TEXT_MESSAGE_START', messageId });
      observer.next({ type: 'TEXT_MESSAGE_CONTENT', delta: 'æ­£åœ¨' });
      observer.next({ type: 'TEXT_MESSAGE_CONTENT', delta: 'ç”Ÿæˆ' });
      observer.next({ type: 'TEXT_MESSAGE_CONTENT', delta: 'ç•Œé¢...' });
      observer.next({ type: 'TEXT_MESSAGE_END', messageId });

      // 3. å‘é€ A2UI ç»„ä»¶
      observer.next({
        type: 'ACTIVITY_SNAPSHOT',
        activityType: 'a2ui-surface',
        content: { operations: [a2ui] },
      });

      // 4. å®Œæˆ
      observer.next({ type: 'RUN_FINISHED', runId, threadId });
      observer.complete(); // æ ‡è®°æµç»“æŸ
    })();
  });
}
```

#### CopilotKit äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `RUN_STARTED` | è¿è¡Œå¼€å§‹ | Agent å¼€å§‹å¤„ç†è¯·æ±‚ |
| `TEXT_MESSAGE_START` | æ–‡æœ¬æ¶ˆæ¯å¼€å§‹ | å‡†å¤‡å‘é€æ–‡æœ¬ |
| `TEXT_MESSAGE_CONTENT` | æ–‡æœ¬å†…å®¹ | å‘é€æ–‡æœ¬ç‰‡æ®µï¼ˆå¯å¤šæ¬¡ï¼‰ |
| `TEXT_MESSAGE_END` | æ–‡æœ¬æ¶ˆæ¯ç»“æŸ | æ–‡æœ¬å‘é€å®Œæˆ |
| `ACTIVITY_SNAPSHOT` | è‡ªå®šä¹‰å†…å®¹å¿«ç…§ | å‘é€ A2UI ç»„ä»¶ |
| `RUN_FINISHED` | è¿è¡Œå®Œæˆ | Agent å¤„ç†å®Œæˆ |
| `RUN_ERROR` | è¿è¡Œé”™è¯¯ | å‘ç”Ÿé”™è¯¯ |

#### Observable vs Promise å¯¹æ¯”

| ç‰¹æ€§ | Promise | Observable |
|-----|---------|-----------|
| **è¿”å›å€¼æ•°é‡** | å•ä¸ª | å¤šä¸ªï¼ˆæµï¼‰ |
| **æ‰§è¡Œæ—¶æœº** | ç«‹å³æ‰§è¡Œ | è®¢é˜…æ—¶æ‰§è¡Œï¼ˆæƒ°æ€§ï¼‰ |
| **å–æ¶ˆèƒ½åŠ›** | âŒ æ— æ³•å–æ¶ˆ | âœ… å¯ä»¥å–æ¶ˆè®¢é˜… |
| **é”™è¯¯å¤„ç†** | catch/finally | error å›è°ƒ |
| **é€‚ç”¨åœºæ™¯** | HTTP è¯·æ±‚ã€å•æ¬¡å¼‚æ­¥æ“ä½œ | æµå¼æ•°æ®ã€äº‹ä»¶æµã€å®æ—¶é€šä¿¡ |
| **CopilotKit æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |

#### æœ€ä½³å®è·µ

**1. å§‹ç»ˆè°ƒç”¨ `complete()`**
```javascript
return new Observable(observer => {
  try {
    observer.next({ type: 'DATA', data });
    observer.complete(); // âœ… å¿…é¡»è°ƒç”¨
  } catch (error) {
    observer.error(error);
  }
});
```

**2. ä½¿ç”¨ async/await å¤„ç†å¼‚æ­¥é€»è¾‘**
```javascript
return new Observable(observer => {
  (async () => {
    // å¼‚æ­¥æ“ä½œ
    const result = await fetchData();
    observer.next({ type: 'RESULT', result });
    observer.complete();
  })();
});
```

**3. é”™è¯¯ä¼˜å…ˆå‘é€äº‹ä»¶**
```javascript
try {
  observer.next({ type: 'DATA', data });
} catch (error) {
  observer.next({ type: 'ERROR', message: error.message }); // å‘é€é”™è¯¯äº‹ä»¶
  observer.error(error); // ç»ˆæ­¢æµ
}
```

#### ä¸ºä»€ä¹ˆä¸ç”¨å…¶ä»–æ–¹æ¡ˆï¼Ÿ

**ä¸ºä»€ä¹ˆä¸ç”¨ Generatorï¼Ÿ**
```javascript
// Generator æ— æ³•å¤„ç†å¼‚æ­¥
function* run() {
  yield { type: 'START' };
  // âŒ æ— æ³• await
  yield { type: 'END' };
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨ EventEmitterï¼Ÿ**
```javascript
// EventEmitter ä¸æ˜¯æ ‡å‡†è¿”å›å€¼ï¼ŒCopilotKit ä¸æ”¯æŒ
function run() {
  const emitter = new EventEmitter();
  emitter.emit('data', {...});
  return emitter; // âŒ ä¸ç¬¦åˆæ¥å£å®šä¹‰
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨ AsyncIteratorï¼Ÿ**
```javascript
// AsyncIterator è¯­æ³•å¤æ‚ï¼ŒCopilotKit ä¸æ”¯æŒ
async function* run() {
  yield { type: 'START' };
  yield { type: 'END' };
}
```

#### æ€»ç»“

**Observable åœ¨ A2UI é¡¹ç›®ä¸­æ˜¯æœ€ä½³é€‰æ‹©ï¼Œå› ä¸ºï¼š**

1. âœ… **æ¡†æ¶è¦æ±‚** - CopilotKit å¼ºåˆ¶ä½¿ç”¨ Observable
2. âœ… **å¤šäº‹ä»¶æµ** - å¯ä»¥å‘é€æ–‡æœ¬ã€ç»„ä»¶ã€çŠ¶æ€ç­‰å¤šç§äº‹ä»¶
3. âœ… **æµå¼ä½“éªŒ** - å®ç°æ¸è¿›å¼åé¦ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ
4. âœ… **é”™è¯¯å¤„ç†** - çµæ´»çš„é”™è¯¯ä¼ é€’æœºåˆ¶
5. âœ… **æ ‡å‡†æ¨¡å¼** - å“åº”å¼ç¼–ç¨‹çš„å·¥ä¸šæ ‡å‡†
6. âœ… **å–æ¶ˆèƒ½åŠ›** - æ”¯æŒè®¢é˜…å–æ¶ˆï¼Œé‡Šæ”¾èµ„æº

**ç®€è€Œè¨€ä¹‹ï¼šPromise åªèƒ½"è¯´ä¸€æ¬¡è¯"ï¼ŒObservable å¯ä»¥"æŒç»­å¯¹è¯"ï¼Œè€Œ AI å¯¹è¯åœºæ™¯å¤©ç„¶éœ€è¦æŒç»­çš„ã€æµå¼çš„äº¤äº’ã€‚**

---

## æ–‡ä»¶å…³ç³»å›¾

```
src/app/page.js
â”œâ”€ å¯¼å…¥: CopilotKitProvider, CopilotChat
â”œâ”€ å¯¼å…¥: createTDesignA2UIRenderer
â””â”€ æ³¨å†Œ: activityRenderers
    â”‚
src/app/api/copilotkit/[[...slug]]/route.js
â”œâ”€ å¯¼å…¥: CopilotRuntime, InMemoryAgentRunner
â”œâ”€ å¯¼å…¥: A2UIAgent
â””â”€ åˆ›å»º: Endpoint
    â”‚
src/lib/copilotkit-a2ui-agent.js
â”œâ”€ ç»§æ‰¿: AbstractAgent (@ag-ui/client)
â”œâ”€ ä½¿ç”¨: Observable (rxjs)
â”œâ”€ è°ƒç”¨: ai-service.js
â”œâ”€ è°ƒç”¨: a2ui-spec.js
â””â”€ è°ƒç”¨: a2ui-validator.js
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚              â”‚
ai-service.js  a2ui-spec.js  a2ui-validator.js
æ··å…ƒ API å°è£…   è§„èŒƒå®šä¹‰      JSON Schema éªŒè¯
    â”‚
src/lib/tdesign-a2ui-renderer.jsx
â”œâ”€ å¯¼å…¥: TDesign React
â”œâ”€ æ¥æ”¶: A2UI JSON
â””â”€ è¾“å‡º: React Element
```

---

## æ•°æ®æµè¯¦è§£

### 1. ç”¨æˆ·å‘é€æ¶ˆæ¯

```
ç”¨æˆ·è¾“å…¥ "åˆ›å»ºç”¨æˆ·æ³¨å†Œè¡¨å•"
  â†“
CopilotChat å‘é€ POST /api/copilotkit
  body: { messages, runId, threadId }
  â†“
CopilotRuntime è°ƒç”¨ A2UIAgent.run()
  â†“
æå–ç”¨æˆ·æ¶ˆæ¯: messages[messages.length - 1].content
  â†“
è°ƒç”¨ processMessage(userInput)
```

### 2. AI ç”Ÿæˆç•Œé¢

```
buildA2UIPrompt(userInput)
  â†’ ç”ŸæˆåŒ…å« A2UI è§„èŒƒçš„ Prompt
  â†“
aiService.generateContent(prompt)
  â†’ è°ƒç”¨è…¾è®¯æ··å…ƒ API
  â†“
æ··å…ƒè¿”å› JSON:
{
  "message": "è¯·å¡«å†™æ³¨å†Œä¿¡æ¯ï¼š",
  "a2ui": {
    "components": [
      { "id": "form-1", "type": "form", ... },
      { "id": "input-1", "type": "textInput", ... }
    ]
  }
}
  â†“
validateA2UIResponse(parsed)
  â†’ éªŒè¯æ ¼å¼å’Œå¼•ç”¨
  â†“
éªŒè¯å¤±è´¥ â†’ é‡è¯•ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰
éªŒè¯æˆåŠŸ â†’ è¿”å›ç»“æœ
```

### 3. æ¸²æŸ“ç»„ä»¶

```
observer.next({
  type: 'ACTIVITY_SNAPSHOT',
  activityType: 'a2ui-surface',
  content: { operations: [a2ui] }
})
  â†“
CopilotKit åŒ¹é… activityType
  â†“
è°ƒç”¨ TDesignRenderer.render({ content })
  â†“
è§£æ components:
  - æå– rootComponents
  - é€’å½’æ¸²æŸ“ children
  - æ˜ å°„åˆ° TDesign ç»„ä»¶
  â†“
è¿”å› React Element
  â†“
åœ¨èŠå¤©ç•Œé¢ä¸­æ˜¾ç¤º
```

---

## å…³é”®æŠ€æœ¯ç»†èŠ‚

### A2UI åè®®

**åŸåˆ™:** æ‰å¹³åŒ– + ID å¼•ç”¨

```json
{
  "message": "ç®€çŸ­æç¤º",
  "a2ui": {
    "components": [
      {
        "id": "form-1",
        "type": "form",
        "props": { "title": "ç”¨æˆ·æ³¨å†Œ" },
        "children": ["input-1", "input-2"]
      },
      {
        "id": "input-1",
        "type": "textInput",
        "props": { "label": "ç”¨æˆ·å" }
      }
    ]
  }
}
```

**ä¼˜åŠ¿:**

- âœ… AI å®¹æ˜“ç”Ÿæˆï¼ˆé¿å…æ·±å±‚åµŒå¥—ï¼‰
- âœ… å¼•ç”¨å…³ç³»æ¸…æ™°
- âœ… æ˜“äºéªŒè¯

### æ™ºèƒ½é‡è¯•æœºåˆ¶

```javascript
for (let attempt = 1; attempt <= MAX_RETRIES + 1; attempt++) {
  try {
    const parsed = this.parseAIResponse(responseText);
    const validation = validateA2UIResponse(parsed);

    if (!validation.valid) {
      // éªŒè¯å¤±è´¥ â†’ é‡è¯•
      currentQuery = this.buildRetryQuery(userMessage, errors);
      continue;
    }

    return parsed;
  } catch (error) {
    if (error.name === 'SyntaxError') {
      // JSON è§£æå¤±è´¥ â†’ é‡è¯•
      currentQuery = this.buildRetryQuery(userMessage, error);
      continue;
    }
  }
}
```

**ç­–ç•¥:**

- JSON è§£æå¤±è´¥ â†’ å‘Šè¯‰ AI å“ªé‡Œé”™äº†
- Schema éªŒè¯å¤±è´¥ â†’ æä¾›é”™è¯¯è¯¦æƒ…
- æœ€å¤šé‡è¯• 2 æ¬¡

### ç»„ä»¶æ˜ å°„

```javascript
const componentMap = {
  form: () => <Form><Space>{children}</Space></Form>,
  textInput: () => <div><FormLabel /><Input /></div>,
  button: () => <Button theme="primary">{label}</Button>,
};

const Component = componentMap[type];
return Component ? Component() : null;
```

---

## æ—¥å¿—è§„èŒƒ

### AI Service

```javascript
console.log('ğŸ¤– AI Service åˆå§‹åŒ–:', { model, temperature });
console.log('ğŸ“¤ å‘é€è¯·æ±‚åˆ°æ··å…ƒ API:', { promptLength });
console.log('âœ… æ··å…ƒ API å“åº”æˆåŠŸ:', { duration, usage });
console.error('âŒ æ··å…ƒ API é”™è¯¯:', status, errorData);
```

### Agent

```javascript
console.log('ğŸš€ Agent å¼€å§‹è¿è¡Œ:', { runId, threadId });
console.log('ğŸ“ ç”¨æˆ·è¾“å…¥:', userInput);
console.log('ğŸ”„ ç¬¬ N æ¬¡å°è¯•ç”Ÿæˆç•Œé¢');
console.warn('âš ï¸ A2UI éªŒè¯å¤±è´¥:', errors);
console.log('ğŸ¨ å‘é€ A2UI ç»„ä»¶:', componentCount);
console.log('âœ… Agent è¿è¡Œå®Œæˆ');
```

---

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°ç»„ä»¶ç±»å‹

1. åœ¨ `a2ui-spec.js` çš„ `A2UI_STANDARD_CATALOG.components` æ·»åŠ å®šä¹‰
2. åœ¨ `a2ui-validator.js` çš„ Schema `enum` ä¸­æ·»åŠ ç±»å‹
3. åœ¨ `tdesign-a2ui-renderer.jsx` çš„ `componentMap` ä¸­æ·»åŠ æ¸²æŸ“

### åˆ‡æ¢ AI æ¨¡å‹

```bash
AI_MODEL=hunyuan-pro
AI_TEMPERATURE=0.5
AI_MAX_TOKENS=4096
```

---

## æ•…éšœæ’æŸ¥

### Agent ä¸å“åº”

**æ£€æŸ¥:**

- æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
- `/api/copilotkit` è·¯ç”±æ˜¯å¦æ­£å¸¸
- Agent æ˜¯å¦æ³¨å†Œåˆ° `InMemoryAgentRunner`

### AI è¿”å›æ ¼å¼é”™è¯¯

**æ£€æŸ¥:**

- æ··å…ƒ API æ˜¯å¦æ­£å¸¸ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
- Prompt æ˜¯å¦å®Œæ•´
- æ˜¯å¦è§¦å‘é‡è¯•ï¼ˆæŸ¥çœ‹ consoleï¼‰

### ç»„ä»¶æ¸²æŸ“å¼‚å¸¸

**æ£€æŸ¥:**

- A2UI JSON æ˜¯å¦é€šè¿‡éªŒè¯
- `children` å¼•ç”¨çš„ ID æ˜¯å¦å­˜åœ¨
- `componentMap` æ˜¯å¦æ”¯æŒè¯¥ç±»å‹

---

## æ€»ç»“

| ä¾èµ– | ä½œç”¨ | æ–‡ä»¶ |
|------|------|------|
| **CopilotKit** | å¯¹è¯åŸºç¡€è®¾æ–½ï¼Œç®¡ç† Agent | `page.js`, `route.js` |
| **@ag-ui/client** | Agent æ ‡å‡†æ¥å£ | `copilotkit-a2ui-agent.js` |
| **RxJS** | æµå¼å“åº”ï¼Œäº‹ä»¶æµ | `copilotkit-a2ui-agent.js` |
| **A2UI** | ç»„ä»¶åè®®ï¼ŒJSON æ ¼å¼ | `a2ui-spec.js`, `a2ui-validator.js` |
| **TDesign** | UI ç»„ä»¶åº“ | `tdesign-a2ui-renderer.jsx` |

**æ ¸å¿ƒæµç¨‹:** ç”¨æˆ·è¾“å…¥ â†’ Agent â†’ AI ç”Ÿæˆ JSON â†’ éªŒè¯ â†’ TDesign æ¸²æŸ“ â†’ æ˜¾ç¤º
